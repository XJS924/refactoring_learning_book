#### 第8章 重新组织数据

##### 8.1 self Encapsulate Field (自封装字段)

你直接访问一个字段，但与字段之间的耦合关系逐渐变得笨拙。

**为这个字段建立取值、设置函数，并且只以这些函数来访问字段。**

**动机**

- 间接访问变量的好处是，子类可以通过覆写一个函数而改变获取数据的途径，他还支持更灵活的数据管理方式，例如延迟初始化。

**做法**

- 为待封装字段建立set/get方法

- 找出该字段的所有引用点，将他们全部改为set/get方法；

  > 如果引用点要读取字段值，就将它替换为调用取值函数；如果引用点要给字段赋值，就将它替换为调用set函数。

  > 你可以暂时将该字段改名，让编译器帮助你查找引用点。

- 将该字段声明为private。

- 复查，确保找出所有引用点，

- 编译，测试。

##### 8.2 Replace Data Value with Object(以对象取代数据值)

你有个数据项，需要与其他数据和行为一起使用才有意义。

**将数据项变成对象。**

**动机**

- 开发初期，简单的数据项表示简单的情况，随着开发进行，这些数据项会涉及相关的处理函数。这是应该将数据值变成对象。

**做法**

- 为待替换数值新建一个类，在其中声明一个final字段，其类型和源类中的待替换数值类型一样。然后在新类中加入这个字段的取值函数，再加上一个接受此字段为参数的构造函数。
- 编译。
- 将源类中的待替换数值字段的类型改为前面新建的类。
- 修改源类中该字段的取值函数，令他调用新类的取值函数。
- 如果源类构造函数中用到这个待替换字段（多半是赋值动作），我们就修改构造函数，令他改用新类的构造函数对字段进行赋值动作。
- 修改源类中待替换字段的设值函数，令他为新类创建一个实例。
- 编译、测试
- 现在，你有可能需要对新类使用change value to reference(179).



##### 8.3 Change Value to Reference (将值对象改为引用对象)

你从一个类衍生出许多彼此相等的实例，希望将他们替换成同一个对象。

**将这个值对象变成引用对象**

**动机**

- 值对象与引用对象，使用==检查对象的同一性，检查两个对象是否相等。检查值对象是否相等，需要覆写equals()以及hashCode()函数。
- 你可能会希望给对象加入一些可修改数据，并确保对任何一个对象的修改都能影响到所有引用此一对象的地方。这时你就要将这个对象变成一个引用对象。

**做法**

- 使用Replace Constructor with Factory Method(304)

- 编译，测试。

- 决定由什么对象负责提供访问新对象的途径。

  > 可能是一个静态字典或一个注册表对象

  > 你也可以使用多个对象作为新对象的访问点。

- 决定这些引用对象应该预先创建好，或是应该动态创建。

  > 如果这些引用对象是预先创建好的，而你必须从内存中将他们读取出来，那么就得确保他们是被需要的时候能够被及时加载。

- 修改工厂函数，令他返回引用对象。

  > 如果对象是预先创建好的，你就需要考虑，万一有人索求一个其实并不存在的对象，要如何处理错误？

  > 你可能希望对工厂函数使用Rename Method（273），使其传达这样的信息：它返回的是一个既存对象。

- 编译测试。

